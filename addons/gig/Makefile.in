topsrc = @top_srcdir@
prefix = @prefix@
datarootdir = @datarootdir@
tooldir = $(topsrc)/tools

MAKE = @MAKE@
INSTALL = @INSTALL@

ifeq ($(INSTALL_DATA),)
  INSTALL_DATA = $(INSTALL) -m 644
endif

GFNDIR = $(prefix)/share/gretl/functions
GRETLCLI = ../../cli/gretlcli

PKG = gig
PKGSRC = $(topsrc)/addons/$(PKG)

vpath %.inp $(PKGSRC)
vpath %.spec $(PKGSRC)

INP = gig_estimate.inp \
      gig_mle.inp \
      gig_plot.inp \
      gig_printout.inp \
      gig_setup.inp

$(PKG).gfn: links.stamp $(INP) $(PKG).spec $(GRETLCLI)
	$(GRETLCLI) -b -q pkg.inp

doc/gig.pdf:
	$(MAKE) -C doc

links.stamp:
	@if [ ! -f $(PKG).spec ] ; then ln -sf $(PKGSRC)/$(PKG).spec . ; fi
	@if [ ! -f test.sh ] ; then ln -sf $(PKGSRC)/test.sh . ; fi
	@if [ ! -d examples ] ; then ln -s $(PKGSRC)/examples . ; fi
	@touch $@

$(PKG).zip: $(PKG).gfn doc/$(PKG).pdf $(GRETLCLI)
	echo makepkg $(PKG).zip | $(GRETLCLI) -b -

.PHONY : check install installdirs clean

check: $(PKG).gfn
	./test.sh $(GRETLCLI)

install: $(PKG).gfn doc/$(PKG).pdf installdirs
	$(INSTALL_DATA) $(PKG).gfn $(DESTDIR)$(GFNDIR)/$(PKG)
	$(INSTALL_DATA) doc/$(PKG).pdf $(DESTDIR)$(GFNDIR)/$(PKG)
	for f in examples/* ; do \
	$(INSTALL_DATA) $$f $(DESTDIR)$(GFNDIR)/$(PKG)/examples ; done

installdirs:
	$(tooldir)/mkinstalldirs $(DESTDIR)$(GFNDIR)/$(PKG)
	$(tooldir)/mkinstalldirs $(DESTDIR)$(GFNDIR)/$(PKG)/examples

clean: 
	@rm -f $(PKG).gfn $(PKG)-i18n.c $(PKG).xml $(PKG).zip links.stamp
	@rm -f *.pdf test.out
	@$(MAKE) -C doc clean


